<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalender 2026</title>
  <style>
    :root{
      --bg:#0b1020; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.65); --border:rgba(255,255,255,.12);
      --shadow:0 18px 50px rgba(0,0,0,.45); --accent:#7c3aed; --red:#ef4444; --green:#22c55e;
      --chip:rgba(255,255,255,.10);
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb; --card:rgba(0,0,0,.04); --card2:rgba(0,0,0,.06);
      --text:rgba(0,0,0,.88); --muted:rgba(0,0,0,.60); --border:rgba(0,0,0,.10);
      --shadow:0 18px 50px rgba(0,0,0,.14); --accent:#6d28d9; --chip:rgba(0,0,0,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.35), transparent 55%),
                  radial-gradient(1200px 700px at 80% 0%, rgba(34,197,94,.22), transparent 50%),
                  radial-gradient(900px 600px at 90% 80%, rgba(239,68,68,.20), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 32px;display:grid;gap:14px}

    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px;border:1px solid var(--border);
      background:linear-gradient(180deg, var(--card2), var(--card));
      border-radius:16px;box-shadow:var(--shadow);backdrop-filter: blur(10px);
      position:sticky;top:10px;z-index:5;
    }

    .title{display:flex;flex-direction:column;gap:6px;min-width:0}
    .title h1{
      margin:0;
      font-weight:900;
      letter-spacing:.2px;
      font-size: clamp(20px, 3.8vw, 34px);
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .title .sub{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}

    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .btn, select{
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    .btn{cursor:pointer;user-select:none}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(124,58,237,.30), rgba(124,58,237,.16));
      border-color: rgba(124,58,237,.35);
    }
    .btn.ghost{background:transparent}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:var(--chip);font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.red{background:var(--red)}
    .dot.green{background:var(--green)}
    .dot.purple{background:var(--accent)}

    .grid{display:grid;grid-template-columns:1.55fr 1fr;gap:14px;align-items:start}
    @media (max-width:920px){
      .grid{grid-template-columns:1fr}
      header{position:static}
    }

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, var(--card2), var(--card));
      border-radius:18px;box-shadow:var(--shadow);backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .cal-head{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:14px 14px 10px;border-bottom:1px solid var(--border);
    }
    .cal-head .left{display:flex;flex-direction:column;gap:4px;min-width:0}
    .monthTitle{
      font-size:15px;font-weight:800;letter-spacing:.2px;margin:0;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .hint{font-size:12px;color:var(--muted)}
    .cal-head .nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:10px 12px 0}
    .dow div{font-size:12px;color:var(--muted);text-align:center;padding:8px 0;border-radius:10px}
    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:10px 12px 14px}

    .day{
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px 10px 8px;
      min-height:72px;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:6px;
      justify-content:space-between;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    :root[data-theme="light"] .day{background: rgba(0,0,0,.015)}
    .day:hover{transform: translateY(-1px); border-color: rgba(124,58,237,.35)}
    .day.muted{opacity:.45;cursor:default;border-style:dashed}

    .day .top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .dateNum{font-weight:900;font-size:14px;line-height:1}
    .mini{font-size:11px;color:var(--muted);display:flex;justify-content:space-between;gap:6px;flex-wrap:wrap}

    /* Warna tanggal */
    .day.redDay{
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.08));
      border-color: rgba(239,68,68,.35);
    }
    .day.greenDay{
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.08));
      border-color: rgba(34,197,94,.35);
    }

    /* Hari ini: titik hijau kedip */
    .todayBlink{
      position:absolute;top:10px;right:10px;
      width:10px;height:10px;border-radius:50%;
      background: rgba(34,197,94,1);
      box-shadow: 0 0 0 0 rgba(34,197,94,.55);
      animation: pulse 1.1s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{transform:scale(.85);box-shadow:0 0 0 0 rgba(34,197,94,.55);opacity:.95}
      60%{transform:scale(1.05);box-shadow:0 0 0 10px rgba(34,197,94,0);opacity:1}
      100%{transform:scale(.85);box-shadow:0 0 0 0 rgba(34,197,94,0);opacity:.85}
    }

    .panel{padding:14px;display:flex;flex-direction:column;gap:10px}
    .panel h2{margin:0;font-size:14px;letter-spacing:.2px}
    .panel .meta{display:flex;flex-wrap:wrap;gap:8px}
    .kv{
      padding:10px 12px;border-radius:14px;border:1px solid var(--border);
      background:var(--chip);min-width:140px;flex:1;
    }
    .kv .k{font-size:11px;color:var(--muted);margin-bottom:4px}
    .kv .v{font-size:13px;font-weight:800;line-height:1.2}

    .times{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media (max-width:520px){ .times{grid-template-columns:repeat(2,1fr)} }
    .timeBox{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--chip)}
    .timeBox .t{font-size:11px;color:var(--muted);margin-bottom:3px}
    .timeBox .h{font-size:14px;font-weight:900}
    .note{font-size:12px;color:var(--muted);line-height:1.45}
    .hr{height:1px;background:var(--border);margin:2px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Kalender 2026</h1>
        <div class="sub">
          <span class="pill"><span class="dot red"></span>Merah: Minggu + libur nasional</span>
          <span class="pill"><span class="dot green"></span>Hijau: cuti bersama</span>
          <span class="pill"><span class="dot purple"></span>Klik tanggal untuk detail</span>
        </div>
      </div>

      <div class="toolbar">
        <select id="monthSelect" title="Pilih bulan"></select>
        <button class="btn ghost" id="prevBtn" title="Bulan sebelumnya">◀</button>
        <button class="btn ghost" id="nextBtn" title="Bulan berikutnya">▶</button>
        <button class="btn primary" id="todayBtn" title="Ke hari ini">Hari ini</button>
        <button class="btn" id="themeBtn" title="Ganti mode">Dark/Light</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="cal-head">
          <div class="left">
            <p class="monthTitle" id="monthTitle">—</p>
            <div class="hint" id="monthHint">—</div>
          </div>
          <div class="nav">
            <span class="pill">
              Wilayah: <b id="locLabel" style="font-weight:800">Kota Kediri, Jawa Timur</b>
            </span>
            <span class="pill" title="Metode perhitungan (fixed)">
              Method: <b style="font-weight:800">11</b>
            </span>
          </div>
        </div>

        <div class="dow" id="dow"></div>
        <div class="days" id="days"></div>
      </div>

      <div class="card">
        <div class="panel">
          <h2>Detail tanggal</h2>

          <div class="meta">
            <div class="kv">
              <div class="k">Tanggal (Masehi)</div>
              <div class="v" id="d_masehi">Klik salah satu tanggal</div>
            </div>
            <div class="kv">
              <div class="k">Hijriyah</div>
              <div class="v" id="d_hijri">—</div>
            </div>
            <div class="kv">
              <div class="k">Pasaran Jawa</div>
              <div class="v" id="d_pasaran">—</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="meta">
            <div class="kv">
              <div class="k">Status</div>
              <div class="v" id="d_status">—</div>
            </div>
            <div class="kv">
              <div class="k">Keterangan</div>
              <div class="v" id="d_ket">—</div>
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <select id="regionSelect" title="Pilih kabupaten/kota (Jawa Timur)" style="flex:1; min-width: 240px;"></select>
            <button class="btn" id="applyLocBtn">Terapkan</button>
          </div>

          <div class="note" id="apiNote">Jadwal sholat diambil saat tanggal dipilih.</div>

          <div class="times">
            <div class="timeBox"><div class="t">Imsak</div><div class="h" id="t_imsak">—</div></div>
            <div class="timeBox"><div class="t">Subuh</div><div class="h" id="t_subuh">—</div></div>
            <div class="timeBox"><div class="t">Dzuhur</div><div class="h" id="t_dzuhur">—</div></div>
            <div class="timeBox"><div class="t">Ashar</div><div class="h" id="t_ashar">—</div></div>
            <div class="timeBox"><div class="t">Magrib</div><div class="h" id="t_magrib">—</div></div>
            <div class="timeBox"><div class="t">Isya</div><div class="h" id="t_isya">—</div></div>
          </div>

          <div class="note" style="margin-top:6px">
            Catatan: koordinat wilayah dicari otomatis, lalu jadwal sholat dihitung berbasis koordinat (method=11).
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const YEAR = 2026;
  const METHOD = 11; // fixed [page:1]

  const HOLIDAYS = new Map([
    ["2026-01-01","Tahun Baru 2026 Masehi"],
    ["2026-01-16","Isra Mikraj Nabi Muhammad S.A.W."],
    ["2026-02-17","Tahun Baru Imlek 2577 Kongzili"],
    ["2026-03-19","Hari Suci Nyepi (Tahun Baru Saka 1948)"],
    ["2026-03-21","Idul Fitri 1447 Hijriah"],
    ["2026-03-22","Idul Fitri 1447 Hijriah"],
    ["2026-04-03","Wafat Yesus Kristus"],
    ["2026-04-05","Kebangkitan Yesus Kristus (Paskah)"],
    ["2026-05-01","Hari Buruh Internasional"],
    ["2026-05-14","Kenaikan Yesus Kristus"],
    ["2026-05-27","Idul Adha 1447 Hijriah"],
    ["2026-05-31","Hari Raya Waisak 2570 BE"],
    ["2026-06-01","Hari Lahir Pancasila"],
    ["2026-06-16","1 Muharam Tahun Baru Islam 1448 Hijriah"],
    ["2026-08-17","Proklamasi Kemerdekaan"],
    ["2026-08-25","Maulid Nabi Muhammad S.A.W."],
    ["2026-12-25","Kelahiran Yesus Kristus"],
  ]);

  const CUTI = new Map([
    ["2026-02-16","Cuti Bersama Tahun Baru Imlek 2577 Kongzili"],
    ["2026-03-18","Cuti Bersama Hari Suci Nyepi"],
    ["2026-03-20","Cuti Bersama Idul Fitri 1447 Hijriah"],
    ["2026-03-23","Cuti Bersama Idul Fitri 1447 Hijriah"],
    ["2026-03-24","Cuti Bersama Idul Fitri 1447 Hijriah"],
    ["2026-05-15","Cuti Bersama Kenaikan Yesus Kristus"],
    ["2026-05-28","Cuti Bersama Idul Adha 1447 Hijriah"],
    ["2026-12-24","Cuti Bersama Kelahiran Yesus Kristus (Natal)"],
  ]);

  // Pasaran Jawa (5 hari) - epoch: 1970-01-01 = Kamis Wage
  const PASARAN = ["Legi","Pahing","Pon","Wage","Kliwon"];
  const BASE_UTC = Date.UTC(1970,0,1);
  const BASE_PASARAN_INDEX = 3; // Wage

  // 38 wilayah Jatim
  const REGIONS = [
    { id:"kab-bangkalan",     label:"Kab. Bangkalan",     q:"Kabupaten Bangkalan, Jawa Timur, Indonesia" },
    { id:"kab-banyuwangi",    label:"Kab. Banyuwangi",    q:"Kabupaten Banyuwangi, Jawa Timur, Indonesia" },
    { id:"kab-blitar",        label:"Kab. Blitar",        q:"Kabupaten Blitar, Jawa Timur, Indonesia" },
    { id:"kab-bojonegoro",    label:"Kab. Bojonegoro",    q:"Kabupaten Bojonegoro, Jawa Timur, Indonesia" },
    { id:"kab-bondowoso",     label:"Kab. Bondowoso",     q:"Kabupaten Bondowoso, Jawa Timur, Indonesia" },
    { id:"kab-gresik",        label:"Kab. Gresik",        q:"Kabupaten Gresik, Jawa Timur, Indonesia" },
    { id:"kab-jember",        label:"Kab. Jember",        q:"Kabupaten Jember, Jawa Timur, Indonesia" },
    { id:"kab-jombang",       label:"Kab. Jombang",       q:"Kabupaten Jombang, Jawa Timur, Indonesia" },
    { id:"kab-kediri",        label:"Kab. Kediri",        q:"Kabupaten Kediri, Jawa Timur, Indonesia" },
    { id:"kab-lamongan",      label:"Kab. Lamongan",      q:"Kabupaten Lamongan, Jawa Timur, Indonesia" },
    { id:"kab-lumajang",      label:"Kab. Lumajang",      q:"Kabupaten Lumajang, Jawa Timur, Indonesia" },
    { id:"kab-madiun",        label:"Kab. Madiun",        q:"Kabupaten Madiun, Jawa Timur, Indonesia" },
    { id:"kab-magetan",       label:"Kab. Magetan",       q:"Kabupaten Magetan, Jawa Timur, Indonesia" },
    { id:"kab-malang",        label:"Kab. Malang",        q:"Kabupaten Malang, Jawa Timur, Indonesia" },
    { id:"kab-mojokerto",     label:"Kab. Mojokerto",     q:"Kabupaten Mojokerto, Jawa Timur, Indonesia" },
    { id:"kab-nganjuk",       label:"Kab. Nganjuk",       q:"Kabupaten Nganjuk, Jawa Timur, Indonesia" },
    { id:"kab-ngawi",         label:"Kab. Ngawi",         q:"Kabupaten Ngawi, Jawa Timur, Indonesia" },
    { id:"kab-pacitan",       label:"Kab. Pacitan",       q:"Kabupaten Pacitan, Jawa Timur, Indonesia" },
    { id:"kab-pamekasan",     label:"Kab. Pamekasan",     q:"Kabupaten Pamekasan, Jawa Timur, Indonesia" },
    { id:"kab-pasuruan",      label:"Kab. Pasuruan",      q:"Kabupaten Pasuruan, Jawa Timur, Indonesia" },
    { id:"kab-ponorogo",      label:"Kab. Ponorogo",      q:"Kabupaten Ponorogo, Jawa Timur, Indonesia" },
    { id:"kab-probolinggo",   label:"Kab. Probolinggo",   q:"Kabupaten Probolinggo, Jawa Timur, Indonesia" },
    { id:"kab-sampang",       label:"Kab. Sampang",       q:"Kabupaten Sampang, Jawa Timur, Indonesia" },
    { id:"kab-sidoarjo",      label:"Kab. Sidoarjo",      q:"Kabupaten Sidoarjo, Jawa Timur, Indonesia" },
    { id:"kab-situbondo",     label:"Kab. Situbondo",     q:"Kabupaten Situbondo, Jawa Timur, Indonesia" },
    { id:"kab-sumenep",       label:"Kab. Sumenep",       q:"Kabupaten Sumenep, Jawa Timur, Indonesia" },
    { id:"kab-trenggalek",    label:"Kab. Trenggalek",    q:"Kabupaten Trenggalek, Jawa Timur, Indonesia" },
    { id:"kab-tuban",         label:"Kab. Tuban",         q:"Kabupaten Tuban, Jawa Timur, Indonesia" },
    { id:"kab-tulungagung",   label:"Kab. Tulungagung",   q:"Kabupaten Tulungagung, Jawa Timur, Indonesia" },

    { id:"kota-batu",         label:"Kota Batu",          q:"Kota Batu, Jawa Timur, Indonesia" },
    { id:"kota-blitar",       label:"Kota Blitar",        q:"Kota Blitar, Jawa Timur, Indonesia" },
    { id:"kota-kediri",       label:"Kota Kediri",        q:"Kota Kediri, Jawa Timur, Indonesia" },
    { id:"kota-madiun",       label:"Kota Madiun",        q:"Kota Madiun, Jawa Timur, Indonesia" },
    { id:"kota-malang",       label:"Kota Malang",        q:"Kota Malang, Jawa Timur, Indonesia" },
    { id:"kota-mojokerto",    label:"Kota Mojokerto",     q:"Kota Mojokerto, Jawa Timur, Indonesia" },
    { id:"kota-pasuruan",     label:"Kota Pasuruan",      q:"Kota Pasuruan, Jawa Timur, Indonesia" },
    { id:"kota-probolinggo",  label:"Kota Probolinggo",   q:"Kota Probolinggo, Jawa Timur, Indonesia" },
    { id:"kota-surabaya",     label:"Kota Surabaya",      q:"Kota Surabaya, Jawa Timur, Indonesia" },
  ];

  const monthNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
  const dowNames = ["Min","Sen","Sel","Rab","Kam","Jum","Sab"];

  // Theme
  const root = document.documentElement;
  const themeBtn = document.getElementById("themeBtn");
  root.dataset.theme = localStorage.getItem("theme") || "dark";
  themeBtn.addEventListener("click", () => {
    root.dataset.theme = (root.dataset.theme === "dark") ? "light" : "dark";
    localStorage.setItem("theme", root.dataset.theme);
  });

  // Elements
  const monthSelect = document.getElementById("monthSelect");
  const monthTitle  = document.getElementById("monthTitle");
  const monthHint   = document.getElementById("monthHint");
  const dowEl       = document.getElementById("dow");
  const daysEl      = document.getElementById("days");

  const d_masehi = document.getElementById("d_masehi");
  const d_hijri  = document.getElementById("d_hijri");
  const d_pas    = document.getElementById("d_pasaran");
  const d_status = document.getElementById("d_status");
  const d_ket    = document.getElementById("d_ket");

  const t_imsak  = document.getElementById("t_imsak");
  const t_subuh  = document.getElementById("t_subuh");
  const t_dzuhur = document.getElementById("t_dzuhur");
  const t_ashar  = document.getElementById("t_ashar");
  const t_magrib = document.getElementById("t_magrib");
  const t_isya   = document.getElementById("t_isya");
  const apiNote  = document.getElementById("apiNote");

  const regionSelect = document.getElementById("regionSelect");
  const applyLocBtn = document.getElementById("applyLocBtn");
  const locLabel = document.getElementById("locLabel");

  // Persist
  let cfg = { regionId: localStorage.getItem("regionId") || "kota-kediri" };

  // Geo cache
  let geoCache = {};
  try { geoCache = JSON.parse(localStorage.getItem("geoCache") || "{}"); } catch { geoCache = {}; }
  function saveGeoCache(){ try { localStorage.setItem("geoCache", JSON.stringify(geoCache)); } catch {} }

  function fillRegionSelect(){
    regionSelect.innerHTML = "";
    for (const r of REGIONS){
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = r.label;
      regionSelect.appendChild(opt);
    }
    regionSelect.value = cfg.regionId;
  }
  fillRegionSelect();

  function getRegionById(id){
    return REGIONS.find(r => r.id === id) || REGIONS[0];
  }

  locLabel.textContent = `${getRegionById(cfg.regionId).label}, Jawa Timur`;

  applyLocBtn.addEventListener("click", () => {
    cfg.regionId = regionSelect.value;
    localStorage.setItem("regionId", cfg.regionId);
    locLabel.textContent = `${getRegionById(cfg.regionId).label}, Jawa Timur`;
    apiNote.textContent = "Wilayah diterapkan. Pilih tanggal lagi untuk refresh jadwal sholat.";
  });

  function pad2(n){ return String(n).padStart(2, "0"); }
  function isoDate(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

  function getPasaran(y,m,d){
    const utc = Date.UTC(y, m-1, d);
    const diffDays = Math.floor((utc - BASE_UTC) / 86400000);
    const idx = (BASE_PASARAN_INDEX + diffDays) % 5;
    return PASARAN[(idx + 5) % 5];
  }

  function hijriApprox(date){
    try { return new Intl.DateTimeFormat("id-ID-u-ca-islamic", { day:"numeric", month:"long", year:"numeric"}).format(date); }
    catch {
      try { return new Intl.DateTimeFormat("en-u-ca-islamic", { day:"numeric", month:"long", year:"numeric"}).format(date); }
      catch { return "Tidak didukung browser"; }
    }
  }

  function setTimes(times){
    const clean = (s) => (s || "—").replace(/\s*\(.*\)\s*/g, "");
    t_imsak.textContent  = clean(times.Imsak);
    t_subuh.textContent  = clean(times.Fajr);
    t_dzuhur.textContent = clean(times.Dhuhr);
    t_ashar.textContent  = clean(times.Asr);
    t_magrib.textContent = clean(times.Maghrib);
    t_isya.textContent   = clean(times.Isha);
  }
  function clearTimes(){
    setTimes({Imsak:"—",Fajr:"—",Dhuhr:"—",Asr:"—",Maghrib:"—",Isha:"—"});
  }

  async function geocodeRegion(region){
    const cached = geoCache[region.id];
    if (cached && typeof cached.lat === "number" && typeof cached.lon === "number") return cached;

    const u = new URL("https://nominatim.openstreetmap.org/search");
    u.searchParams.set("format", "json");
    u.searchParams.set("limit", "1");
    u.searchParams.set("q", region.q);

    apiNote.textContent = "Mencari koordinat wilayah…";
    const resp = await fetch(u.toString(), { headers: { "Accept-Language": "id,en;q=0.8" } });
    if (!resp.ok) throw new Error("Geocoding gagal");
    const arr = await resp.json();
    const first = arr && arr[0];
    if (!first || !first.lat || !first.lon) throw new Error("Koordinat tidak ditemukan");

    const lat = Number(first.lat), lon = Number(first.lon);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) throw new Error("Koordinat tidak valid");

    const record = { lat, lon, display_name: first.display_name || region.q, ts: Date.now() };
    geoCache[region.id] = record;
    saveGeoCache();
    return record;
  }

  async function fetchPrayerTimesByCoords(y,m,d, lat, lon){
    const dateStr = `${pad2(d)}-${pad2(m)}-${y}`;
    const url = new URL(`https://api.aladhan.com/v1/timings/${dateStr}`);
    url.searchParams.set("latitude", String(lat));
    url.searchParams.set("longitude", String(lon));
    url.searchParams.set("method", String(METHOD)); // fixed [page:1]

    apiNote.textContent = "Mengambil jadwal sholat…";
    const resp = await fetch(url.toString());
    if (!resp.ok) throw new Error("Gagal mengambil data sholat");
    return await resp.json();
  }

  // Month select + DOW
  for (let i = 0; i < 12; i++) {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${monthNames[i]} ${YEAR}`;
    monthSelect.appendChild(opt);
  }
  dowEl.innerHTML = "";
  for (const d of dowNames) {
    const div = document.createElement("div");
    div.textContent = d;
    dowEl.appendChild(div);
  }

  // Navigation
  let currentMonth = 0;
  const today = new Date();
  const isTodayYear = today.getFullYear() === YEAR;
  if (isTodayYear) currentMonth = today.getMonth();
  monthSelect.value = String(currentMonth);

  document.getElementById("prevBtn").addEventListener("click", () => {
    currentMonth = Math.max(0, currentMonth - 1);
    monthSelect.value = String(currentMonth);
    render();
  });
  document.getElementById("nextBtn").addEventListener("click", () => {
    currentMonth = Math.min(11, currentMonth + 1);
    monthSelect.value = String(currentMonth);
    render();
  });
  document.getElementById("todayBtn").addEventListener("click", () => {
    if (!isTodayYear) return;
    currentMonth = today.getMonth();
    monthSelect.value = String(currentMonth);
    render();
    selectDate(today.getDate());
  });
  monthSelect.addEventListener("change", () => {
    currentMonth = parseInt(monthSelect.value, 10);
    render();
  });

  let selectedIso = null;

  async function selectDate(dayNum){
    const y = YEAR, m = currentMonth + 1, d = dayNum;
    const date = new Date(y, currentMonth, d);
    const iso = isoDate(y,m,d);
    selectedIso = iso;

    d_masehi.textContent = date.toLocaleDateString("id-ID", { weekday:"long", day:"numeric", month:"long", year:"numeric" });
    d_hijri.textContent  = hijriApprox(date);
    d_pas.textContent    = getPasaran(y,m,d);

    const isSunday = date.getDay() === 0;
    const holiday = HOLIDAYS.get(iso);
    const cuti = CUTI.get(iso);

    if (holiday || isSunday) d_status.textContent = "Tanggal merah";
    else if (cuti) d_status.textContent = "Cuti bersama";
    else d_status.textContent = "Hari kerja (biasa)";

    d_ket.textContent = holiday || cuti || (isSunday ? "Hari Minggu" : "—");
    clearTimes();

    try{
      const region = getRegionById(cfg.regionId);
      const geo = await geocodeRegion(region);
      if (selectedIso !== iso) return;

      const json = await fetchPrayerTimesByCoords(y,m,d, geo.lat, geo.lon);
      if (selectedIso !== iso) return;

      setTimes(json?.data?.timings || {});
      const hijri = json?.data?.date?.hijri;
      if (hijri && hijri.day && hijri.month && hijri.year) {
        d_hijri.textContent = `${hijri.day} ${hijri.month.en} ${hijri.year} H`;
      }

      apiNote.textContent = `Sumber: AlAdhan • method=${METHOD} • Koordinat: ${geo.lat.toFixed(4)}, ${geo.lon.toFixed(4)}.`;
    } catch {
      apiNote.textContent = "Gagal mengambil jadwal sholat (geocoding/API). Coba lagi beberapa saat.";
    }
  }

  function render(){
    const m = currentMonth + 1;
    monthTitle.textContent = `${monthNames[currentMonth]} ${YEAR}`;
    monthHint.textContent = "Klik tanggal untuk lihat Hijriyah, pasaran, dan jadwal sholat.";

    daysEl.innerHTML = "";

    const first = new Date(YEAR, currentMonth, 1);
    const startDow = first.getDay();
    const daysInMonth = new Date(YEAR, currentMonth + 1, 0).getDate();

    for (let i = 0; i < startDow; i++){
      const cell = document.createElement("div");
      cell.className = "day muted";
      cell.innerHTML = `<div class="top"><div class="dateNum">—</div></div><div class="mini"><span></span></div>`;
      daysEl.appendChild(cell);
    }

    for (let d = 1; d <= daysInMonth; d++){
      const date = new Date(YEAR, currentMonth, d);
      const iso = isoDate(YEAR, m, d);

      const isSunday = date.getDay() === 0;
      const holiday = HOLIDAYS.get(iso);
      const cuti = CUTI.get(iso);

      const cell = document.createElement("div");
      cell.className = "day";
      if (holiday || isSunday) cell.classList.add("redDay");
      else if (cuti) cell.classList.add("greenDay");

      const now = new Date();
      const isToday = (now.getFullYear()===YEAR && now.getMonth()===currentMonth && now.getDate()===d);

      const pasaran = getPasaran(YEAR, m, d);

      cell.innerHTML = `
        <div class="top">
          <div class="dateNum">${d}</div>
        </div>
        <div class="mini">
          <span>${pasaran}</span>
        </div>
      `;

      if (isToday){
        const blink = document.createElement("span");
        blink.className = "todayBlink";
        blink.title = "Hari ini";
        cell.appendChild(blink);
      }

      cell.addEventListener("click", () => selectDate(d));
      daysEl.appendChild(cell);
    }

    if (isTodayYear && today.getMonth() === currentMonth) selectDate(today.getDate());
    else selectDate(1);
  }

  render();
})();
</script>
</body>
</html>
