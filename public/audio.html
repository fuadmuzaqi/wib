<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MP3 Volume Booster + Limiter</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 16px;
}
.card {
  max-width: 480px;
  margin: auto;
  background: #020617;
  padding: 16px;
  border-radius: 12px;
}
h1 {
  text-align: center;
  font-size: 1.2rem;
}
input, button {
  width: 100%;
  margin-top: 12px;
}
button {
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-size: 1rem;
}
.primary {
  background: #22c55e;
}
.secondary {
  background: #38bdf8;
}
audio {
  width: 100%;
  margin-top: 12px;
}
.value {
  text-align: center;
  font-weight: bold;
}
.info {
  font-size: 0.85rem;
  opacity: 0.8;
  text-align: center;
}
</style>
</head>

<body>
<div class="card">
  <h1>ðŸŽµ MP3 Volume Booster</h1>

  <input type="file" id="fileInput" accept="audio/mpeg">

  <label>Skala Volume (0â€“1000)</label>
  <input type="range" min="0" max="1000" value="100" id="volume">
  <div class="value">Volume: <span id="volText">100</span></div>

  <div class="info">ðŸ§  Auto limiter aktif (anti pecah)</div>

  <audio id="preview" controls></audio>

  <button class="primary" id="previewBtn">Preview</button>
  <button class="secondary" id="downloadBtn" disabled>Download MP3</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>

<script>
let audioBuffer;
let finalBuffer;

const fileInput = document.getElementById("fileInput");
const volume = document.getElementById("volume");
const volText = document.getElementById("volText");
const preview = document.getElementById("preview");
const downloadBtn = document.getElementById("downloadBtn");

volume.oninput = () => volText.textContent = volume.value;

fileInput.onchange = async () => {
  const ctx = new AudioContext();
  audioBuffer = await ctx.decodeAudioData(await fileInput.files[0].arrayBuffer());
  preview.src = URL.createObjectURL(fileInput.files[0]);
  downloadBtn.disabled = true;
};

document.getElementById("previewBtn").onclick = async () => {
  if (!audioBuffer) return alert("Upload MP3 dulu");

  const userGain = volume.value / 100;

  // ðŸ”Š First pass
  let buffer = await renderWithGain(audioBuffer, userGain);

  // ðŸ§  Limiter check
  const peak = getPeak(buffer);
  let limiterGain = 1;

  if (peak > 0.99) {
    limiterGain = 0.99 / peak;
    buffer = await renderWithGain(buffer, limiterGain);
  }

  finalBuffer = buffer;
  preview.src = URL.createObjectURL(bufferToWav(buffer));
  downloadBtn.disabled = false;
};

downloadBtn.onclick = () => {
  const mp3Blob = encodeMP3(finalBuffer);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(mp3Blob);
  a.download = "volume_limited.mp3";
  a.click();
};

// ================= AUDIO UTILS =================

async function renderWithGain(sourceBuffer, gainValue) {
  const offline = new OfflineAudioContext(
    sourceBuffer.numberOfChannels,
    sourceBuffer.length,
    sourceBuffer.sampleRate
  );

  const src = offline.createBufferSource();
  const gain = offline.createGain();

  src.buffer = sourceBuffer;
  gain.gain.value = gainValue;

  src.connect(gain);
  gain.connect(offline.destination);
  src.start();

  return await offline.startRendering();
}

function getPeak(buffer) {
  let peak = 0;
  for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
    const data = buffer.getChannelData(ch);
    for (let i = 0; i < data.length; i++) {
      peak = Math.max(peak, Math.abs(data[i]));
    }
  }
  return peak;
}

function bufferToWav(buffer) {
  const length = buffer.length * 2;
  const ab = new ArrayBuffer(44 + length);
  const view = new DataView(ab);

  const write = (o, s) => [...s].forEach((c,i)=>view.setUint8(o+i,c.charCodeAt(0)));

  write(0,"RIFF");
  view.setUint32(4,36+length,true);
  write(8,"WAVEfmt ");
  view.setUint32(16,16,true);
  view.setUint16(20,1,true);
  view.setUint16(22,1,true);
  view.setUint32(24,buffer.sampleRate,true);
  view.setUint32(28,buffer.sampleRate*2,true);
  view.setUint16(32,2,true);
  view.setUint16(34,16,true);
  write(36,"data");
  view.setUint32(40,length,true);

  let offset = 44;
  const data = buffer.getChannelData(0);
  for (let i=0;i<data.length;i++){
    view.setInt16(offset, Math.max(-1,Math.min(1,data[i]))*0x7fff,true);
    offset+=2;
  }
  return new Blob([view],{type:"audio/wav"});
}

function encodeMP3(buffer) {
  const samples = buffer.getChannelData(0);
  const enc = new lamejs.Mp3Encoder(1, buffer.sampleRate, 192);
  const mp3 = [];
  const block = 1152;

  for (let i=0;i<samples.length;i+=block) {
    const slice = samples.subarray(i,i+block);
    const pcm = new Int16Array(slice.length);
    for (let j=0;j<slice.length;j++) {
      pcm[j] = Math.max(-1,Math.min(1,slice[j]))*0x7fff;
    }
    const buf = enc.encodeBuffer(pcm);
    if (buf.length) mp3.push(buf);
  }

  const end = enc.flush();
  if (end.length) mp3.push(end);

  return new Blob(mp3,{type:"audio/mp3"});
}
</script>
</body>
</html>
