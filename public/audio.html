<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MP3 Volume Booster</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 16px;
}
.card {
  max-width: 480px;
  margin: auto;
  background: #020617;
  padding: 16px;
  border-radius: 12px;
}
h1 {
  text-align: center;
  font-size: 1.2rem;
}
input, button {
  width: 100%;
  margin-top: 12px;
}
button {
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-size: 1rem;
}
.primary {
  background: #22c55e;
}
.secondary {
  background: #38bdf8;
}
audio {
  width: 100%;
  margin-top: 12px;
}
.value {
  text-align: center;
  font-weight: bold;
}
</style>
</head>

<body>
<div class="card">
  <h1>ðŸŽµ MP3 Volume Booster</h1>

  <input type="file" id="fileInput" accept="audio/mpeg">

  <label>Skala Volume (0â€“1000)</label>
  <input type="range" min="0" max="1000" value="100" id="volume">
  <div class="value">Volume: <span id="volText">100</span></div>

  <audio id="preview" controls></audio>

  <button class="primary" id="previewBtn">Preview</button>
  <button class="secondary" id="downloadBtn" disabled>Download MP3</button>
</div>

<!-- LAME MP3 WASM -->
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>

<script>
let audioBuffer;
let renderedBuffer;

const fileInput = document.getElementById("fileInput");
const volume = document.getElementById("volume");
const volText = document.getElementById("volText");
const preview = document.getElementById("preview");
const downloadBtn = document.getElementById("downloadBtn");

volume.oninput = () => volText.textContent = volume.value;

fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const ctx = new AudioContext();
  audioBuffer = await ctx.decodeAudioData(await file.arrayBuffer());
  preview.src = URL.createObjectURL(file);
  downloadBtn.disabled = true;
};

document.getElementById("previewBtn").onclick = async () => {
  if (!audioBuffer) return alert("Upload MP3 dulu");

  const scale = volume.value / 100;
  const offline = new OfflineAudioContext(
    audioBuffer.numberOfChannels,
    audioBuffer.length,
    audioBuffer.sampleRate
  );

  const src = offline.createBufferSource();
  const gain = offline.createGain();
  gain.gain.value = scale;

  src.buffer = audioBuffer;
  src.connect(gain);
  gain.connect(offline.destination);
  src.start();

  renderedBuffer = await offline.startRendering();
  preview.src = URL.createObjectURL(bufferToWav(renderedBuffer));
  downloadBtn.disabled = false;
};

downloadBtn.onclick = async () => {
  const mp3Blob = encodeMP3(renderedBuffer);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(mp3Blob);
  a.download = "volume_boosted.mp3";
  a.click();
};

function bufferToWav(buffer) {
  const len = buffer.length * 2;
  const ab = new ArrayBuffer(44 + len);
  const view = new DataView(ab);

  const write = (o, s) => [...s].forEach((c,i)=>view.setUint8(o+i,c.charCodeAt(0)));

  write(0,"RIFF");
  view.setUint32(4,36+len,true);
  write(8,"WAVEfmt ");
  view.setUint32(16,16,true);
  view.setUint16(20,1,true);
  view.setUint16(22,1,true);
  view.setUint32(24,buffer.sampleRate,true);
  view.setUint32(28,buffer.sampleRate*2,true);
  view.setUint16(32,2,true);
  view.setUint16(34,16,true);
  write(36,"data");
  view.setUint32(40,len,true);

  let offset = 44;
  const data = buffer.getChannelData(0);
  for (let i=0;i<data.length;i++){
    view.setInt16(offset, Math.max(-1,Math.min(1,data[i]))*0x7fff,true);
    offset+=2;
  }
  return new Blob([view],{type:"audio/wav"});
}

function encodeMP3(buffer) {
  const samples = buffer.getChannelData(0);
  const mp3enc = new lamejs.Mp3Encoder(1, buffer.sampleRate, 192);
  const mp3Data = [];
  const block = 1152;

  for (let i = 0; i < samples.length; i += block) {
    const slice = samples.subarray(i, i + block);
    const pcm = new Int16Array(slice.length);
    for (let j=0;j<slice.length;j++){
      pcm[j] = Math.max(-1,Math.min(1,slice[j])) * 0x7fff;
    }
    const mp3buf = mp3enc.encodeBuffer(pcm);
    if (mp3buf.length) mp3Data.push(mp3buf);
  }

  const end = mp3enc.flush();
  if (end.length) mp3Data.push(end);

  return new Blob(mp3Data,{type:"audio/mp3"});
}
</script>
</body>
</html>
